name: Build iOS App with EAS

on:
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Build profile to use'
        required: true
        default: 'preview-device'
        type: choice
        options:
          - preview-device
          - development
          - production
          - testflight
      build_message:
        description: 'Build message'
        required: false
        default: 'GitHub Actions build'

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run TypeScript check
        run: npx tsc --noEmit

      - name: ğŸ§¹ Run ESLint
        run: npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0

      - name: ğŸ”§ Setup environment
        run: |
          echo "Setting up build environment..."
          echo "Build profile: ${{ github.event.inputs.build_profile }}"
          echo "Build message: ${{ github.event.inputs.build_message }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: ğŸ Build iOS app
        run: |
          echo "Starting EAS build..."
          eas build --platform ios --profile ${{ github.event.inputs.build_profile }} --local --output ./build.ipa --message "${{ github.event.inputs.build_message }}" --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          EXPO_APPLE_PASSWORD: ${{ secrets.EXPO_APPLE_PASSWORD }}
          EXPO_TEAM_ID: ${{ secrets.EXPO_TEAM_ID }}
          EAS_PROJECT_ID: e3775235-7f75-42c8-906e-8171c4a1e54b
          CI: true

      - name: ğŸ“± Upload build artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ios-build-${{ github.event.inputs.build_profile }}-${{ github.run_number }}
          path: ./build.ipa
          retention-days: 30

      - name: ğŸ“‹ Generate build info
        if: always()
        run: |
          echo "=== BUILD INFORMATION ===" > build-info.txt
          echo "Status: ${{ job.status }}" >> build-info.txt
          echo "Profile: ${{ github.event.inputs.build_profile }}" >> build-info.txt
          echo "Message: ${{ github.event.inputs.build_message }}" >> build-info.txt
          echo "Run Number: ${{ github.run_number }}" >> build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt
          echo "Timestamp: $(date)" >> build-info.txt
          echo "=========================" >> build-info.txt

      - name: ğŸ“‹ Upload build info
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-info-${{ github.run_number }}
          path: build-info.txt
          retention-days: 30

      - name: ğŸ‰ Build Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Build completed successfully!"
          echo "ğŸ“± Your iOS app is ready for download from the artifacts section."
          echo "ğŸ”— Build profile: ${{ github.event.inputs.build_profile }}"

      - name: âŒ Build Failure Notification
        if: failure()
        run: |
          echo "âŒ Build failed!"
          echo "ğŸ“‹ Check the build logs above for details."
          echo "ğŸ’¡ Common issues: TypeScript errors, missing dependencies, or EAS configuration problems."
          echo "ğŸ”‘ For Apple credential issues, make sure you've run 'eas build' locally first to set up credentials."
          echo "ğŸ Also ensure EXPO_APPLE_ID, EXPO_APPLE_PASSWORD, and EXPO_TEAM_ID secrets are set in GitHub." 